/*!!
* kalimdor.js v0.1.0
* Copyright 2013-11-07
* Author xiangwenwen
* Github https://github.com/xiangwenwe/kalimdor
* Dependent LAB.js,jQuery.js,underscore.js
*/
 
 (function(t,e){var i=t.document;t.navigator,t.location;var n=/(^|.*[\\\/])kalimdor.min(?:_basic)?.js(?:\?.*)?$/i;if(!t.kalimdor){if(!t.kalimdor){t.kalimdor={};var a=kalimdor.pathinfo={},o=t.kalimdor||"",l=function(){var t=i.getElementsByTagName("script")[0];return o=t.src.match(n)[1]};a.LocaPath=l()}var r=kalimdor;r.getURL=function(){var t=i.location.href,e=t.substring(0,t.lastIndexOf("/"));return e},kalimdor.ui={};var d=function(t,e){kalimdor.ui[t]=function(t,i){return new e(t,i)}};r.ajax={getSrv:function(t){var e={type:"GET",dataType:"json",complete:function(){},success:function(e){"function"==typeof t.callback&&t.callback(e)},error:function(){alert("服务加载错误")}};$.ajax($.extend(e,t))}};var c=function(t,n,a){if(n===e){var o=null;if(i.cookie&&""!=i.cookie)for(var l=i.cookie.split(";"),r=0;l.length>r;r++){var d=jQuery.trim(l[r]);if(d.substring(0,t.length+1)==t+"="){o=decodeURIComponent(d.substring(t.length+1));break}}return o}a=a||{},null===n&&(n="",a=$.extend({},a),a.expires=-1);var c="";if(a.expires&&("number"==typeof a.expires||a.expires.toUTCString)){var u;"number"==typeof a.expires?(u=new Date,u.setTime(u.getTime()+1e3*60*60*a.expires)):u=a.expires,c="; expires="+u.toUTCString()}var s=a.path?"; path="+a.path:"",p=a.domain?"; domain="+a.domain:"",h=a.secure?"; secure":"";i.cookie=[t,"=",encodeURIComponent(n),c,s,p,h].join("")};r.cookie={setCookie:function(t,i,n){var a=n;a===e&&(a={path:"/",expires:1}),c(t,i,n)},getCookie:function(t){return t===e?null:c(t)}},r.com={getWidth:function(){var t=i.documentElement,e=i.body;return self.innerWidth||t&&t.clientWidth||t.offsetWidth||(null!=e?e.clientWidth:0)},getHeight:function(){var t=i.documentElement,e=i.body;return self.innerHeight||t&&t.clientHeight||t.offsetHeight||(null!=e?e.clientHeight:0)},isArray:function(t){return"[object Array]"===Object.prototype.toString.call(t)},isObject:function(t){return"[object Object]"===Object.prototype.toString.call(t)},inArray:function(t,e){for(var i=0,n=t.length;n>i;i++)if(t[i]===e)return i;return-1},getHead:function(){var t=i.getElementsByTagName("head")[0];return t||(t=i.getDocumentElement().append("head")),t}};var u=function(){var t=r.com,e=t.getWidth(),i=t.getHeight(),n="";return n+='<div id="waitIco" style="position:absolute;background:#fff;opacity:10;z-index:1000;width:'+e+"px;height:"+i+'px;">',n+='<div style="background:url(css/image/waitloaded.gif);position: absolute;width:48px;height:48px;top:'+(i-48)/2+"px;left:"+(e-48)/2+'px;" alt="wati"></div>',n+="</div>",$("body").prepend(n),{RemoveWaitIco:function(){$("#waitIco").hide()},ShowWaitIco:function(){$("#waitIco").show()}}};r.LoadFile=function(){var t=r.com.getHead(),e=i.createElement("script");return e.type="text/javascript",e.src=r.pathinfo.LocaPath+"LAB.min.js",t.appendChild(e),{_loadinit:function(t,e,i){i.LoadFile._Load_Scr(t,function(){var t=i.config.style,n=i.config.library;if(0!==t.length&&i.com.isArray(t))for(var a=0,o=t.length;o>a;a++)i.LoadFile.LoadStyle(t[a]);if(0!==n.length&&i.com.isArray(n)){for(var l=[],r=0,d=n.length;d>r;r++)l.push("libs/"+n[r]);i.LoadFile.LoadScript(l,e)}})},LoadStyle:function(t){var e=r.com.getHead(),n=i.createElement("link");n.setAttribute("rel","stylesheet"),n.setAttribute("type","text/css"),n.setAttribute("href","css/"+t),e.appendChild(n)},_Load_Scr:function(t,i){e.onload=function(){t.length>0&&$LAB.script(t).wait(function(){i()})}},LoadScript:function(t,e){$LAB.script(t).wait(function(){e()})}}}(),function(t){t.LoadFile._loadinit(["libs/config.js"],function(){t.addplug=d,t.wait=u();var i=kalimdor.config.plug,n=kalimdor.config.debug,a=[];n!==e&&n!==!1&&a.push("libs/kalimdor.debug.js"),"all"===i?a.push("libs/kalimdor.ui.js"):$.each(i,function(t,e){a.push("libs/plug/"+e+".js")}),$(function(){kalimdor.LoadFile.LoadScript(a,function(){var e=$("#controllers").attr("ctrl").split("|"),i=[];$.each(e,function(t){i.push("controllers/"+e[t]+".js")}),t.controllers.LoadControllers(i,t)})})},t)}(r);var s=[],p={},h=function(t,e,i){if(null!==typeof i.ioc){var n=e;$("#"+i.ioc).append(_.template(t,{value:n})),"function"==typeof callback&&callback()}};r.get=function(t){return r.model.GATHERMODEL[t].data.value},r.set=function(t,e){var i=r.model.GATHERMODEL[t],n=p[i.view],a=[];a.push(e),h(n.loadStr,a,n)},r.otherCtrl=function(){var t=this;this.GATHERCTRL={},this.CTRLNAME=[],this.CHILDCTRL=function(){},this.add=function(e,i){t.CTRLNAME.push(e),t.GATHERCTRL[e]=new i}};var v=r.controllers=new r.otherCtrl;v.LoadControllers=function(t){r.LoadFile.LoadScript(t,function(){var t=new r.controllers.CHILDCTRL,e=r.controllers.GATHERCTRL;t.CTRL=e,t._CTRLNAME=r.controllers.CTRLNAME,t.Views=[],$.each(t.CTRL,function(e,i){"none"!==i.views?t.Views.push("views/"+i.views+".js"):(i.init(),r.wait.RemoveWaitIco())}),r.view.LoadViews(t.Views,t)})},v.action=function(t){$.each(t,function(t,i){$.each(i,function(i,n){$("#"+i)[0]!==e&&(s.push({type:t,ele:$("#"+i),affair_fun:n}),$("#"+i).bind(t,n))})})},v.saveJSON=function(t){var i=[],n=null,a=null,o=function(t){for(var n=0,a=t.length;a>n;n++)for(var o=t[n].field,l=0,r=o.length;r>l;l++)o[l].id!==e&&i.push({id:o[l].id,value:$("#"+o[l].id).val()})};if("string"==typeof t)n=r.model.GATHERMODEL[t],n.dataServer!==e&&(a=n.data.value,o(a));else{n=r.model.GATHERMODEL;for(x in n)n[x].dataServer!==e&&(a=n[x].data.value,o(a))}var l=this.verifyvalue(i);return l?JSON.stringify(i):!1},v.verifyvalue=function(t){for(var i=t,n=[],a=!1,o=0,l=i.length;l>o;o++)0!==i[o].value.length||(n.push({id:i[o].id,value:"值为空"}),a=!0);return a?(kalimdor.debug!==e&&kalimdor.debug.value_error(n),!1):!0},r.otherView=function(){var t=this;this.GATHERVIEW={},this.VIEWNAME=[],this.CHILDVIEW=function(){},this.add=function(e,i){t.VIEWNAME.push(e),t.GATHERVIEW[e]=new i}};var f=r.view=new r.otherView;f.LoadViews=function(t,i){r.LoadFile.LoadScript(t,function(){var t=new r.view.CHILDVIEW,n=r.view.GATHERVIEW;t.VIEW=n,t._VIEWNAME=r.view.VIEWNAME,t.Models=[],t.MVC_CTRL={},$.each(i.CTRL,function(e,i){t.MVC_CTRL[i.views]=i}),$.each(t.VIEW,function(i,n){var a=p[i]={};n.loadStr!==e&&"string"==typeof n.loadStr()?(n.loadStr=n.loadStr(),a.loadStr=n.loadStr,a.ioc=t.MVC_CTRL[i].ioc):n.loadServer!==e&&"string"==typeof n.loadServer?(n.loadServer=n.loadServer,a.loadStr="",a.ioc=""):(a.loadStr="",a.ioc=""),"none"!==n.model&&t.Models.push("models/"+n.model+".js")}),r.model.loadM(t.Models,t,i)})},f.LoadServerView=function(t,i,n){r.ajax.getSrv({url:t,type:"GET",dataType:"html",callback:function(t){p[i.view].loadStr=t,p[i.view].ioc=n.ioc,r.model.getTemplate(t,i,n,function(){n.init(),n.action!==e&&v.action(n.action)})}})},r.otherModel=function(){var t=this;this.GATHERMODEL={},this.MODELNAME=[],this.CHILDMODEL=function(){},this.add=function(e,i){t.MODELNAME.push(e),t.GATHERMODEL[e]=new i}};var m=r.model=new r.otherModel;m.loadM=function(t,i){r.LoadFile.LoadScript(t,function(){var n=new r.model.CHILDMODEL,a=r.model.GATHERMODEL;n.MODEL=a,n._MODELNAME=r.model.MODELNAME;var o=[];for(var l in n.MODEL){var d=n.MODEL[l],c=i.MVC_CTRL[d.view];c!==e||kalimdor.debug===e?d.dataServer===e?(i.VIEW[d.view]!==e&&i.VIEW[d.view].loadStr!==e&&r.model.getTemplate(i.VIEW[d.view].loadStr,d,c,function(){c.init(),c.action!==e&&v.action(c.action),c.automation!==e&&m.automation(c.automation,d)}),i.VIEW[d.view]!==e&&"string"==typeof i.VIEW[d.view].loadServer&&r.view.LoadServerView(i.VIEW[d.view].loadServer,d,c)):r.model.loadDataServer(d.dataServer,d,c):o.push({errorfile:t,errorinfo:d})}0!==o.length&&r.debug.system_error(o),r.wait.RemoveWaitIco()})},m.loadDataServer=function(t,i,n){r.ajax.getSrv({url:t,dataType:"json",type:"GET",callback:function(t){if(t.Template!==e){var a={data:{value:t.value}};i.data=a.data,p[i.view].loadStr=t.Template,p[i.view].ioc=n.ioc,r.model.renderingTemplate(t.Template,a,n,function(){if(n.init(),n.action!==e&&v.action(n.action),n.automation!==e)for(var t=a.data.value,i=0,o=t.length;o>i;i++){var l={data:{value:t[i].field}};r.model.automation(n.automation,l)}})}}})};var g=[],b=!1;m.renderingTemplate=function(t,e,i,n){for(var a,o=t,l=i.ioc.split(","),e=e.data.value,r=0,d=e.length;d>r;r++){var c={data:{value:e[r].field}},u={ioc:l[r]};a="string"==typeof o?o:o[r],m.getTemplate(a,c,u,function(){g.push(r)}),g.length===e.length&&(b=!0)}b&&"function"==typeof n&&n()},m.getTemplate=function(t,e,i,n){if(null!==typeof i.ioc){var a=e.data.value;$("#"+i.ioc).append(_.template(t,{value:a})),"function"==typeof n&&n()}},m.automation=function(t,e){var i=t.split(","),n=e.data.value;$.each(i,function(t,e){$.each(n,function(t,i){i.type===e&&kalimdor.ui[e](i.id,i)})})},console.log(r)}})(window);